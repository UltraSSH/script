import time
import requests
from telegram import Update
from telegram.ext import Updater, CommandHandler, CallbackContext

# Configurações do bot
BOT_TOKEN = "7661626757:AAFzcchrgW6I_Vt8UWqw7hcgG-eGNF-inkU"
CHAT_ID = 943180105
CHECK_INTERVAL = 120  # Intervalo em segundos (2 minutos)

# Lista para armazenar os sites a serem monitorados
monitored_sites = {}
last_status = {}

# Função de boas-vindas
def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "Olá! Sou seu bot de monitoramento de sites.\n"
        "Comandos disponíveis:\n"
        "/addsite <URL> - Adicionar um site para monitoramento\n"
        "/removesite <URL> - Remover um site do monitoramento\n"
        "/list - Listar sites monitorados\n"
        "/status - Verificar o status atual dos sites\n"
    )

# Função para adicionar um site para monitoramento
def add_site(update: Update, context: CallbackContext):
    if len(context.args) != 1:
        update.message.reply_text("Uso: /addsite <URL>")
        return

    site = context.args[0]
    if site in monitored_sites:
        update.message.reply_text(f"O site {site} já está sendo monitorado.")
    else:
        monitored_sites[site] = True
        last_status[site] = True
        update.message.reply_text(f"Adicionado: {site} ao monitoramento.")

# Função para remover um site do monitoramento
def remove_site(update: Update, context: CallbackContext):
    if len(context.args) != 1:
        update.message.reply_text("Uso: /removesite <URL>")
        return

    site = context.args[0]
    if site in monitored_sites:
        del monitored_sites[site]
        del last_status[site]
        update.message.reply_text(f"Removido: {site} do monitoramento.")
    else:
        update.message.reply_text(f"O site {site} não está sendo monitorado.")

# Função para listar os sites monitorados
def list_sites(update: Update, context: CallbackContext):
    if not monitored_sites:
        update.message.reply_text("Nenhum site está sendo monitorado no momento.")
    else:
        sites = "\n".join(monitored_sites.keys())
        update.message.reply_text(f"Sites monitorados:\n{sites}")

# Função para verificar o status dos sites
def status(update: Update, context: CallbackContext):
    if not monitored_sites:
        update.message.reply_text("Nenhum site está sendo monitorado no momento.")
        return

    message = "Status dos sites:\n"
    for site in monitored_sites:
        try:
            response = requests.get(site, timeout=5)
            if response.status_code == 200:
                message += f"{site} - **Online**\n"
            else:
                message += f"{site} - **Offline**\n"
        except:
            message += f"{site} - **Offline**\n"

    update.message.reply_text(message)

# Função que verifica se algum site ficou online ou offline
def check_sites(context: CallbackContext):
    for site in list(monitored_sites.keys()):
        try:
            response = requests.get(site, timeout=5)
            current_status = response.status_code == 200
        except:
            current_status = False

        # Se o status mudou, envie uma notificação
        if current_status != last_status[site]:
            last_status[site] = current_status
            chat_id = context.job.context
            if current_status:
                context.bot.send_message(chat_id=chat_id, text=f"O site {site} voltou a ficar **online**!")
            else:
                context.bot.send_message(chat_id=chat_id, text=f"O site {site} ficou **offline**!")

# Função principal
def main():
    updater = Updater(BOT_TOKEN)
    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("addsite", add_site))
    dispatcher.add_handler(CommandHandler("removesite", remove_site))
    dispatcher.add_handler(CommandHandler("list", list_sites))
    dispatcher.add_handler(CommandHandler("status", status))

    # Configura a tarefa de monitoramento
    job_queue = updater.job_queue
    job_queue.run_repeating(check_sites, interval=CHECK_INTERVAL, first=0, context=CHAT_ID)

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
